name: Inferno Reference Server CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  SERVER_URL: https://inferno.healthit.gov/reference-server/r4
  INFERNO_DISABLE_TLS_TEST: true

jobs:

  test:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      # Clean this or adapt this for using a specific version of inferno reference server from repo
      # - name: Start server
      #   run: |
      #     docker compose build
      #     docker compose up -d
      #     ${{ github.workspace }}/.github/wait-for.sh localhost:8080 -- echo "Server ready"

      - name: Start Inferno services
        run: |
          gem install foreman
          bundle exec inferno migrate
          bundle exec inferno services start
          curl --head --silent --fail --retry-connrefused --retry 5 --retry-delay 30 -X GET http://localhost:80/hl7validatorapi/validator/version
          echo "Inferno Services are ready"

      - name: Run g10 test kit Single Patient API and Multi-Patient API with US Core 3.1.1 and Bulk Data 1.0.1
        run: |
          bundle exec inferno execute --suite g10_certification \
                                      --suite-options us_core_version:us_core_3 \
                                                      smart_app_launch_version:smart_app_launch_1 \
                                                      multi_patient_version:multi_patient_api_stu1 \
                                      --groups 4 7 \
                                      --preset-id g10-reference-server

      - name: Run g10 test kit Single Patient API and Multi-Patient API with US Core 6.1.0 and Bulk Data 2.0.0
        working-directory: ${{ github.workspace }}/${{ env.TEST_KIT_NAME }}
        run: |
          bundle exec inferno execute --suite g10_certification \
                                      --suite-options us_core_version:us_core_6 \
                                                      smart_app_launch_version:smart_app_launch_2 \
                                                      multi_patient_version:multi_patient_api_stu2 \
                                      --groups 10 8 \
                                      --preset-id g10-reference-server

      # Likewise
      # - name: Stop server
      #   run: docker compose down
      #   if: ${{ always() }}

      - name: Stop Inferno services
        run: bundle exec inferno services stop
        if: ${{ always() }}
